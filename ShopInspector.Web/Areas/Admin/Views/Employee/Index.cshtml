@using ShopInspector.Core.Entities
@using ShopInspector.Web.Areas.Admin.Models
@model PaginatedList<EmployeeListViewModel>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Employees";
}

<div class="asset-page">
    <!-- Header row: title left, add button right (same line) -->
    <div class="asset-header-row">
        <h2 class="asset-title">Employees</h2>
        <a asp-area="Admin"
           asp-controller="Employee"
           asp-action="Create"
           class="btn btn-primary asset-add-btn"
           title="Add Employee">
            <i class="bi bi-plus-circle"></i> <span>Add Employee</span>
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-wrapper">
            <div class="search-input-group">
                <i class="bi bi-search search-icon"></i>
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="Search by employee name or email..." 
                       value="@ViewData["SearchTerm"]"
                       autocomplete="off">
                <button type="button" class="clear-search-btn" id="clearSearch">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="search-info">
                <i class="bi bi-info-circle"></i>
                <span id="searchResults">
                    @if (Model?.TotalCount > 0)
                    {
                        <span class="search-results-count">@Model.TotalCount</span>
                        <span> employee@(Model.TotalCount == 1 ? "" : "s") found</span>
                    }
                    else
                    {
                        <span>No employees found</span>
                    }
                </span>
            </div>
        </div>
    </div>

    <!-- Table Container -->
    <div id="tableContainer" class="mt-3">
        @await Html.PartialAsync("_TablePartial", Model)
    </div>
</div>

@section Scripts {
    <script src="~/js/admin-actions.js"></script>
    <script>
        let currentPageSize = 5; // Set to match controller
        let currentSearchTerm = '@ViewData["SearchTerm"]';
        let searchTimeout;

        // Search functionality
        $(document).ready(function() {
            const searchInput = $('#searchInput');
            const clearButton = $('#clearSearch');

            // Handle search input with debouncing
            searchInput.on('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = $(this).val();
                
                // Show/hide clear button
                if (searchTerm.length > 0) {
                    clearButton.show();
                } else {
                    clearButton.hide();
                }

                // Debounce search to avoid too many requests
                searchTimeout = setTimeout(function() {
                    performSearch(searchTerm);
                }, 500);
            });

            // Handle Enter key
            searchInput.on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    clearTimeout(searchTimeout);
                    performSearch($(this).val());
                }
            });

            // Clear search
            clearButton.on('click', function() {
                searchInput.val('');
                clearButton.hide();
                performSearch('');
            });
        });

        function performSearch(searchTerm) {
            currentSearchTerm = searchTerm;
            console.log('Searching for:', searchTerm);
            
            // Show loading state
            $('#tableContainer').html('<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            
            $.ajax({
                url: '/Admin/Employee/LoadTable',
                type: 'GET',
                data: { 
                    pageIndex: 1, 
                    pageSize: currentPageSize, 
                    searchTerm: searchTerm 
                },
                success: function(result) {
                    $('#tableContainer').html(result);
                    
                    // Update search results info
                    const totalCount = parseInt($('#tableContainer').attr('data-total-count')) || 0;
                    updateSearchResultsInfo(totalCount, searchTerm);
                    
                    console.log('Search completed for:', searchTerm, 'Results:', totalCount);
                },
                error: function(xhr, status, error) {
                    console.error('Search error:', error);
                    $('#tableContainer').html(
                        '<div class="alert alert-danger">' +
                        '<i class="bi bi-exclamation-triangle"></i> ' +
                        'Error searching. Please try again.' +
                        '</div>'
                    );
                }
            });
        }

        function updateSearchResultsInfo(totalCount, searchTerm) {
            const resultsSpan = $('#searchResults');
            if (totalCount > 0) {
                if (searchTerm && searchTerm.trim().length > 0) {
                    resultsSpan.html(
                        `<span class="search-results-count">${totalCount}</span> ` +
                        `employee${totalCount === 1 ? '' : 's'} found for "<strong>${searchTerm}</strong>"`
                    );
                } else {
                    resultsSpan.html(
                        `<span class="search-results-count">${totalCount}</span> ` +
                        `employee${totalCount === 1 ? '' : 's'} found`
                    );
                }
            } else {
                if (searchTerm && searchTerm.trim().length > 0) {
                    resultsSpan.html(`employees found for "<strong>${searchTerm}</strong>"`);
                } else {
                    resultsSpan.html('No employees found');
                }
            }
        }

        // Handle pagination clicks with improved error handling and logging
        $(document).on('click', '.page-btn', function(e) {
            e.preventDefault();
            
            if ($(this).closest('.disabled').length) {
                console.log('Pagination button is disabled, ignoring click');
                return false;
            }
            
            const pageIndex = $(this).data('page');
            console.log('Employee pagination clicked: Page', pageIndex);
            
            // Show loading state
            $('#tableContainer').html('<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
            
            $.ajax({
                url: '/Admin/Employee/LoadTable',
                type: 'GET',
                data: { 
                    pageIndex: pageIndex, 
                    pageSize: currentPageSize,
                    searchTerm: currentSearchTerm 
                },
                success: function(result) {
                    $('#tableContainer').html(result);
                    console.log('Successfully loaded Employee page', pageIndex);
                    
                    // Scroll to table top for better UX
                    $('#tableContainer')[0].scrollIntoView({ behavior: 'smooth' });
                },
                error: function(xhr, status, error) {
                    console.error('Error loading Employee table:', error);
                    $('#tableContainer').html(
                        '<div class="alert alert-danger">' +
                        '<i class="bi bi-exclamation-triangle"></i> ' +
                        'Error loading data. Please refresh the page and try again.' +
                        '</div>'
                    );
                }
            });
        });

        // Handle delete forms with AJAX
        $(document).on('submit', '.delete-form', function(e) {
            e.preventDefault();
            
            const confirmMessage = $(this).data('confirm');
            if (!confirm(confirmMessage)) {
                return false;
            }
            
            const form = $(this);
            const formData = new FormData(this);
            
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Mark as AJAX request
                },
                success: function(result) {
                    if (result.success) {
                        // Show success message
                        $('.alert').remove();
                        $('<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">' +
                          '<i class="bi bi-check-circle-fill"></i> ' + result.message +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                          '</div>').insertAfter('.asset-header-row');
                        
                        // Reload table via AJAX (stay on same page)
                        const currentPage = $('.pagination .page-item.active .page-btn').data('page') || 1;
                        $.ajax({
                            url: '/Admin/Employee/LoadTable',
                            type: 'GET',
                            data: { 
                                pageIndex: currentPage, 
                                pageSize: currentPageSize,
                                searchTerm: currentSearchTerm 
                            },
                            success: function(data) {
                                $('#tableContainer').html(data);
                                console.log('Employee table reloaded after delete');
                                
                                // Update search results info
                                const totalCount = parseInt($('#tableContainer').attr('data-total-count')) || 0;
                                updateSearchResultsInfo(totalCount, currentSearchTerm);
                            },
                            error: function() {
                                // Fallback to page 1 if current page fails
                                $.get('/Admin/Employee/LoadTable?pageIndex=1&pageSize=' + currentPageSize + '&searchTerm=' + encodeURIComponent(currentSearchTerm), function(data) {
                                    $('#tableContainer').html(data);
                                    const totalCount = parseInt($('#tableContainer').attr('data-total-count')) || 0;
                                    updateSearchResultsInfo(totalCount, currentSearchTerm);
                                });
                            }
                        });
                    } else {
                        // Check if it requires confirmation for force delete
                        if (result.requiresConfirmation) {
                            showEnhancedEmployeeDeleteDialog(result);
                        } else {
                            // Show regular warning message
                            $('.alert').remove();
                            $('<div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">' +
                              '<i class="bi bi-exclamation-triangle-fill"></i> ' + result.message +
                              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                              '</div>').insertAfter('.asset-header-row');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting employee:', error);
                    $('.alert').remove();
                    $('<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">' +
                      '<i class="bi bi-exclamation-triangle-fill"></i> Error deleting employee. Please try again.' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                      '</div>').insertAfter('.asset-header-row');
                }
            });
        });

        // Enhanced delete dialog with detailed information for employees - RESPONSIVE VERSION
        function showEnhancedEmployeeDeleteDialog(result) {
            const relatedData = result.relatedData || {};
            
            // Create responsive modal dialog with proper mobile/tablet support
            const modalHtml = `
                <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-responsive modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title d-flex align-items-center gap-2">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    <span class="title-text">Cannot Delete Employee: ${result.employeeName}</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body modal-body-responsive">
                                <div class="alert-message">
                                    ${result.message}
                                </div>
                                
                                <div class="related-data-container">
                                    <div class="related-data-title">
                                        <i class="bi bi-info-circle text-primary"></i>
                                        Related Data Details:
                                    </div>
                                    <div class="related-data-grid">
                                        <div class="data-item">
                                            <span class="data-label">Total Inspections:</span>
                                            <span class="data-value">${relatedData.inspectionCount || 0}</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Last Inspection:</span>
                                            <span class="data-value">${relatedData.lastInspectionDate || 'N/A'}</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Affected Assets:</span>
                                            <span class="data-value">${relatedData.totalAffectedAssets || 0} asset(s)</span>
                                        </div>
                                        <div class="data-item">
                                            <span class="data-label">Checklist Items:</span>
                                            <span class="data-value">${relatedData.checklistItemsCount || 0} item(s)</span>
                                        </div>
                                    </div>
                                    
                                    ${relatedData.affectedAssets && relatedData.affectedAssets.length > 0 ? 
                                        `<div class="affected-items-section">
                                            <strong class="section-title">Affected Assets:</strong>
                                            <div class="items-list">
                                                ${relatedData.affectedAssets.map(asset => `<span class="item-tag">${asset}</span>`).join('')}
                                                ${relatedData.totalAffectedAssets > relatedData.affectedAssets.length ? 
                                                    `<span class="more-items">... and ${relatedData.totalAffectedAssets - relatedData.affectedAssets.length} more</span>` : ''}
                                            </div>
                                        </div>` : ''
                                    }
                                </div>
                                
                                <div class="options-container">
                                    <div class="options-title mb-3">
                                        <i class="bi bi-exclamation-triangle text-warning"></i>
                                        You have two options:
                                    </div>
                                    <div class="action-buttons d-flex flex-column flex-sm-row gap-2">
                                        <button type="button" class="btn btn-info btn-action d-flex align-items-center justify-content-center gap-2" 
                                                onclick="showManageEmployeeRelatedData('${result.employeeId}', '${result.employeeName}')">
                                            <i class="bi bi-list-check"></i> 
                                            <span class="btn-text">Show me what to delete first</span>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-action d-flex align-items-center justify-content-center gap-2" 
                                                onclick="confirmEmployeeForceDelete('${result.employeeId}', '${result.employeeName}')">
                                            <i class="bi bi-trash"></i> 
                                            <span class="btn-text">Force delete everything</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer modal-footer-responsive">
                                <button type="button" class="btn btn-secondary btn-responsive" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal and add new one
            $('#deleteModal').remove();
            $('body').append(modalHtml);
            $('#deleteModal').modal('show');
        }

        // Show what needs to be managed first for employees - RESPONSIVE VERSION
        function showManageEmployeeRelatedData(employeeId, employeeName) {
            $('#deleteModal').modal('hide');
            
            const managementOptionsHtml = `
                <div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-responsive modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title d-flex align-items-center gap-2">
                                    <i class="bi bi-list-check"></i> 
                                    <span class="title-text">Manage Related Data for: ${employeeName}</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body modal-body-responsive">
                                <p class="mb-3">You need to manage the following before deleting this employee:</p>
                                <div class="management-options">
                                        <div class="option-content">
                                            <strong class="option-title">Delete Asset Inspections</strong>
                                            <small class="option-description">View and reassign inspections performed by this employee</small>
                                        </div>                                   
                                    <a href="/Admin/Asset?assignedEmployee=${employeeId}" class="management-option">
                                        <div class="option-icon">
                                            <i class="bi bi-box"></i>
                                        </div>
                                        <div class="option-content">
                                            <strong class="option-title">Manage Asset Assignments</strong>
                                            <small class="option-description">Reassign assets currently assigned to this employee</small>
                                        </div>
                                        <div class="option-arrow">
                                            <i class="bi bi-arrow-right"></i>
                                        </div>
                                    </a>
                                    <div class="management-option alternative-option">
                                        <div class="option-icon">
                                            <i class="bi bi-info-circle text-info"></i>
                                        </div>
                                        <div class="option-content">
                                            <strong class="option-title">Alternative: Force Delete</strong>
                                            <small class="option-description">Or you can force delete to remove all related data automatically</small>
                                            <button type="button" class="btn btn-danger btn-sm mt-2 force-delete-btn" 
                                                    onclick="confirmEmployeeForceDelete('${employeeId}', '${employeeName}')">
                                                <i class="bi bi-trash"></i> Force Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer modal-footer-responsive">
                                <button type="button" class="btn btn-secondary btn-responsive" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#manageModal').remove();
            $('body').append(managementOptionsHtml);
            $('#manageModal').modal('show');
        }

        // Confirm force delete for employees
        function confirmEmployeeForceDelete(employeeId, employeeName) {
            $('.modal').modal('hide');
            
            const forceDeleteConfirm = confirm(
                `FINAL WARNING: This will permanently delete:\n\n` +
                `• Employee: ${employeeName}\n` +
                `• All inspection records they performed\n` +
                `• All associated inspection data\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Do you want to proceed?`
            );
            
            if (forceDeleteConfirm) {
                // Perform force delete
                $.ajax({
                    url: '/Admin/Employee/ForceDelete',
                    type: 'POST',
                    data: { 
                        id: employeeId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(forceResult) {
                        if (forceResult.success) {
                            // Show success message
                            $('.alert').remove();
                            $('<div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">' +
                              '<i class="bi bi-exclamation-triangle-fill"></i> ' + forceResult.message +
                              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                              '</div>').insertAfter('.asset-header-row');
                            
                            // Reload table
                            const currentPage = $('.pagination .page-item.active .page-btn').data('page') || 1;
                            $.ajax({
                                url: '/Admin/Employee/LoadTable',
                                type: 'GET',
                                data: { 
                                    pageIndex: currentPage, 
                                    pageSize: currentPageSize,
                                    searchTerm: currentSearchTerm 
                                },
                                success: function(data) {
                                    $('#tableContainer').html(data);
                                    const totalCount = parseInt($('#tableContainer').attr('data-total-count')) || 0;
                                    updateSearchResultsInfo(totalCount, currentSearchTerm);
                                },
                                error: function() {
                                    $.get('/Admin/Employee/LoadTable?pageIndex=1&pageSize=' + currentPageSize + '&searchTerm=' + encodeURIComponent(currentSearchTerm), function(data) {
                                        $('#tableContainer').html(data);
                                        const totalCount = parseInt($('#tableContainer').attr('data-total-count')) || 0;
                                        updateSearchResultsInfo(totalCount, currentSearchTerm);
                                    });
                                }
                            });
                        } else {
                            $('.alert').remove();
                            $('<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">' +
                              '<i class="bi bi-exclamation-triangle-fill"></i> ' + forceResult.message +
                              '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                              '</div>').insertAfter('.asset-header-row');
                        }
                    },
                    error: function() {
                        $('.alert').remove();
                        $('<div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">' +
                          '<i class="bi bi-exclamation-triangle-fill"></i> Error performing force delete. Please try again.' +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                          '</div>').insertAfter('.asset-header-row');
                    }
                });
            }
        }

        // Make functions globally available
        window.showManageEmployeeRelatedData = showManageEmployeeRelatedData;
        window.confirmEmployeeForceDelete = confirmEmployeeForceDelete;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Employee search and pagination system initialized');
            console.log('Current search term:', currentSearchTerm);
            console.log('Current page size:', currentPageSize);
            
            // Initialize search state
            if (currentSearchTerm) {
                $('#searchInput').val(currentSearchTerm);
                $('#clearSearch').show();
            }
            
            // Focus search input on page load for better UX
            $('#searchInput').focus();
        });
    </script>
}

<style>
/* Employee Search Section Styles */
.search-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.search-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}

.search-input-group {
    position: relative;
    flex: 1;
    min-width: 250px;
    max-width: 500px;
    margin-right: 1rem;
}

.search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.search-input {
    width: 100%;
    padding: 0.75rem 2rem 0.75rem 2.5rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.clear-search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 3px;
    transition: color 0.2s ease;
}

.clear-search-btn:hover {
    color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.search-info {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.search-results-count {
    font-weight: 500;
    color: #333;
    margin-right: 0.2rem;
}
</style>
